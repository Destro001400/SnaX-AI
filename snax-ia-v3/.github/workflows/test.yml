name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10']

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install PyTorch CPU
      run: |
        pip install torch --index-url https://download.pytorch.org/whl/cpu
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test imports
      run: |
        python -c "from model_v3 import SnaXIA_v3"
        python -c "from tokenizer_v3 import SnaXTokenizer_v3"
    
    - name: Test model
      run: |
        python -c "
        from model_v3 import SnaXIA_v3
        import torch
        
        # Configuração do modelo
        config = {
            'vocab_size': 8192,
            'hidden_size': 384,
            'num_layers': 6,
            'num_heads': 6,
            'num_kv_heads': 2,
            'max_seq_len': 512,
        }
        
        # Criar modelo
        model = SnaXIA_v3(config)
        
        # Teste de forward pass
        batch_size = 2
        seq_len = 32
        x = torch.randint(0, config['vocab_size'], (batch_size, seq_len))
        y = model(x)
        
        # Verificar shape da saída
        assert y.shape == (batch_size, seq_len, config['vocab_size']), \
            f'Shape incorreto: {y.shape}'
        
        print('✅ Todos os testes passaram!')
        "